<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KCI Admin</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body style="padding:1rem;">
  <h2>Admin Panel</h2>
  <div style="display:flex;gap:1rem;">
    <div style="flex:1;">
      <h4>Pending user approvals</h4>
      <div id="pendingList"></div>
    </div>
    <div style="flex:1;">
      <h4>Settings</h4>
      <label>Admin Email</label>
      <input id="adminEmail" style="width:100%;padding:.5rem;margin-bottom:.5rem" />
      <button id="saveAdmin" class="upload-btn">Save</button>
      <hr />
      <button id="goTracker" class="upload-btn">Open Tracker</button>
    </div>
  </div>

  <script type="module">
    import { app, db, auth } from "./firebase-init.js";
    import { collection, getDocs, doc, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const pendingList = document.getElementById('pendingList');
    const adminEmailInput = document.getElementById('adminEmail');
    const saveAdminBtn = document.getElementById('saveAdmin');
    const goTracker = document.getElementById('goTracker');

    // only admin allowed
    onAuthStateChanged(auth, async (user)=>{
      if(!user) return window.location.replace('login.html');
      // verify this user is admin by reading settings/access
      const sref = doc(db, "settings", "access");
      const snap = await getDoc(sref);
      if(!snap.exists() || snap.data().adminEmail !== user.email){
        alert('Not authorized.');
        await signOut(auth);
        return window.location.replace('login.html');
      }
      // load pending
      loadPending();
      const s = await getDoc(sref);
      if(s.exists()) adminEmailInput.value = s.data().adminEmail || '';
    });

    async function loadPending(){
      pendingList.innerHTML = '';
      const usersSnap = await getDocs(collection(db, "users"));
      const pending = [];
      usersSnap.forEach(d => {
        const data = d.data();
        if(!data.approved) pending.push({ id: d.id, ...data });
      });
      if(!pending.length) pendingList.innerHTML = '<div>No pending users</div>';
      pending.forEach(u=>{
        const div = document.createElement('div');
        div.style.marginBottom = '.5rem';
        div.innerHTML = `<strong>${u.email || u.id}</strong> â€” <button data-email="${u.id}" class="approve">Approve</button> <button data-email="${u.id}" class="deny">Deny</button>`;
        pendingList.appendChild(div);
      });
      pendingList.querySelectorAll('.approve').forEach(b=>{
        b.addEventListener('click', async (e)=>{
          const em = e.target.dataset.email;
          await updateDoc(doc(db, "users", em), { approved: true });
          alert('Approved ' + em);
          loadPending();
        });
      });
      pendingList.querySelectorAll('.deny').forEach(b=>{
        b.addEventListener('click', async (e)=>{
          const em = e.target.dataset.email;
          await updateDoc(doc(db, "users", em), { approved: false });
          alert('Denied ' + em);
          loadPending();
        });
      });
    }

    saveAdminBtn.addEventListener('click', async ()=>{
      const email = adminEmailInput.value.trim();
      if(!email) return alert('Type admin email');
      await setDoc(doc(db, "settings", "access"), { adminEmail: email });
      alert('Saved');
    });

    goTracker.addEventListener('click', ()=> window.location.href = 'index.html');
  </script>
</body>
</html>