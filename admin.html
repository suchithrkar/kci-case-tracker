<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KCI Case Tracker â€” Admin</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header style="display:flex;align-items:center;gap:1rem;padding:1rem;border-bottom:1px solid #ddd">
    <h2>Admin Dashboard</h2>
    <div style="flex:1"></div>
    <button id="btnBack" class="upload-btn">Back to Tracker</button>
    <button id="btnSignOut" class="upload-btn">Sign Out</button>
  </header>

  <main style="padding:1rem;max-width:1100px;margin:0 auto;">
    <section style="margin-bottom:1rem;">
      <h3>Pending Users</h3>
      <table id="pendingTbl" style="width:100%;border-collapse:collapse;margin-top:.5rem;">
        <thead><tr><th>Email</th><th>Created On</th><th>Actions</th></tr></thead>
        <tbody id="pendingBody"></tbody>
      </table>
    </section>

    <section>
      <h3>Admin Settings</h3>
      <div style="display:flex;gap:.5rem;align-items:center;">
        <input id="adminEmail" placeholder="admin@domain.com" style="padding:.5rem;border-radius:8px;border:1px solid #ccc" />
        <button id="saveAdmin" class="upload-btn">Save Admin Email</button>
      </div>
    </section>
  </main>

  <script type="module">
    import { app } from "./firebase-init.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const auth = getAuth(app);
    const db = getFirestore(app);

    const pendingBody = document.getElementById('pendingBody');
    const adminEmailEl = document.getElementById('adminEmail');
    const saveAdmin = document.getElementById('saveAdmin');
    const btnBack = document.getElementById('btnBack');
    const btnSignOut = document.getElementById('btnSignOut');

    btnBack.addEventListener('click', ()=> location.href = 'index.html');
    btnSignOut.addEventListener('click', async ()=> { await signOut(auth); location.href = 'login.html'; });

    async function ensureAdminAndLoad(){
      const s = await getDoc(doc(db, "settings", "access"));
      const adminEmail = s.exists() ? s.data().adminEmail : null;
      adminEmailEl.value = adminEmail || '';
      // load pending users
      const snap = await getDocs(collection(db, "users"));
      pendingBody.innerHTML = '';
      snap.forEach(d => {
        const data = d.data();
        if (!data.approved){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${data.email}</td><td>${data.createdOn||''}</td><td>
            <button data-email="${data.email}" class="approve">Approve</button>
            <button data-email="${data.email}" class="reject">Reject</button>
          </td>`;
          pendingBody.appendChild(tr);
        }
      });
      pendingBody.querySelectorAll('.approve').forEach(b=>{
        b.addEventListener('click', async ()=> {
          const email = b.dataset.email;
          await setDoc(doc(db,'users',email), { email, approved:true }, { merge:true });
          alert('Approved '+email);
          await ensureAdminAndLoad();
        });
      });
      pendingBody.querySelectorAll('.reject').forEach(b=>{
        b.addEventListener('click', async ()=> {
          const email = b.dataset.email;
          // remove doc (or set approved:false)
          await setDoc(doc(db,'users',email), { email, approved:false }, { merge:true });
          alert('Rejected '+email);
          await ensureAdminAndLoad();
        });
      });
    }

    saveAdmin.addEventListener('click', async ()=>{
      const v = adminEmailEl.value.trim();
      if (!v) return alert('Enter admin email');
      await setDoc(doc(db, 'settings', 'access'), { adminEmail: v }, { merge:true });
      alert('Saved admin email');
    });

    onAuthStateChanged(auth, async (user)=>{
      if (!user) location.href = 'login.html';
      // check user is admin by matching settings doc
      const s = await getDoc(doc(db, "settings", "access"));
      const adminEmail = s.exists() ? s.data().adminEmail : null;
      if (user.email !== adminEmail){
        alert('Only admin can access this page'); await signOut(auth); location.href = 'login.html';
        return;
      }
      ensureAdminAndLoad();
    });
  </script>
</body>
</html>
