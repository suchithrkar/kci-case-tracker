<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — KCI Case Tracker</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body style="padding:18px;">
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
    <h2 style="margin:0">Admin Dashboard</h2>
    <button id="btnTracker" class="upload-btn">Tracker</button>
    <button id="btnSignOut" class="upload-btn">Sign Out</button>
  </div>

  <section>
    <h3>Pending Users</h3>
    <div id="pendingList">Loading…</div>
  </section>

  <section style="margin-top:18px;">
    <h3>App Settings</h3>
    <label>Admin Email</label>
    <input id="adminEmail" style="width:360px;padding:.45rem;border-radius:8px" />
    <div style="margin-top:.5rem">
      <button id="saveAdmin" class="btn">Save Admin Email</button>
    </div>
  </section>

  <script type="module">
  import { db, auth } from "./firebase-init.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { collection, query, where, getDocs, doc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const pendingList = document.getElementById("pendingList");
  const adminEmailInput = document.getElementById("adminEmail");
  const saveAdminBtn = document.getElementById("saveAdmin");
  const btnTracker = document.getElementById("btnTracker");
  const btnSignOut = document.getElementById("btnSignOut");

  onAuthStateChanged(getAuth(), async (user) =>{
    if (!user) return location.replace("login.html");
    // check admin by comparing with settings.access
    try {
      const sdoc = await getDoc(doc(db, "settings", "access"));
      const adminEmail = sdoc.exists() ? sdoc.data().adminEmail : null;
      if (!adminEmail || user.email !== adminEmail) {
        alert("You are not admin.");
        await signOut(getAuth());
        location.replace("login.html");
        return;
      }
      // load pending users
      adminEmailInput.value = adminEmail || "";
      await renderPending();
    } catch (err) {
      console.error(err);
      alert("Admin check failed: " + err.message);
      await signOut(getAuth());
      location.replace("login.html");
    }
  });

  btnTracker.addEventListener("click", ()=> location.href = "index.html");
  btnSignOut.addEventListener("click", async ()=> { await signOut(getAuth()); location.replace("login.html"); });

  async function renderPending(){
    const q = query(collection(db, "users"));
    const snap = await getDocs(q);
    const pending = [];
    snap.forEach(s => {
      const d = s.data();
      if (!d.approved) pending.push(d);
    });
    if (!pending.length) pendingList.innerHTML = "<div>No pending users</div>";
    else {
      pendingList.innerHTML = "";
      pending.forEach(u=>{
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.justifyContent = "space-between";
        row.style.gap = "12px";
        row.style.padding = ".5rem 0";
        row.innerHTML = `<div>${u.email} — created: ${new Date(u.createdOn).toLocaleString()}</div>`;
        const btn = document.createElement("button");
        btn.textContent = "Approve";
        btn.className = "btn";
        btn.addEventListener("click", async ()=>{
          await updateDoc(doc(db, "users", u.email), { approved: true });
          await renderPending();
          alert(u.email + " approved.");
        });
        row.appendChild(btn);
        pendingList.appendChild(row);
      });
    }
  }

  saveAdminBtn.addEventListener("click", async ()=>{
    const val = adminEmailInput.value.trim();
    if (!val) return alert("Enter email");
    await setDoc(doc(db, "settings", "access"), { adminEmail: val });
    alert("Saved.");
  });

  </script>
</body>
</html>
